name: PR Nudge Bot

on:
  schedule:
    - cron: '0 */2 * * *'
  
  workflow_dispatch:
    inputs:
      sla_threshold_hours:
        description: 'Override SLA threshold (e.g. 18)'
        required: false
        default: ''
        type: string
      team_mentions:
        description: 'Override mentions for this run (e.g. @Ahmed)'
        required: false
        default: ''
        type: string

jobs:
  nudge-stale-prs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.BASECAMP_WEBHOOK_URL }}" ]; then
            echo "âŒ Error: BASECAMP_WEBHOOK_URL secret is missing."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch and Filter Stale PRs
        id: filter-prs
        env:
          REPO_SLA_THRESHOLD: ${{ vars.DEFAULT_SLA_THRESHOLD }}
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            const manualSla = `${{ github.event.inputs.sla_threshold_hours }}`;
            const repoSla = process.env.REPO_SLA_THRESHOLD;
            const fallbackSla = 20;

            let slaThreshold = fallbackSla;
            if (manualSla && manualSla.trim() !== "" && manualSla.trim() !== "undefined") {
                slaThreshold = parseFloat(manualSla);
            } else if (repoSla && repoSla.trim() !== "") {
                slaThreshold = parseFloat(repoSla);
            }

            console.log(`Using SLA Threshold: ${slaThreshold} hours`);

            const now = new Date();
            const qualifyingPrs = [];

            for (const pr of pullRequests) {
              if (pr.draft) continue;

              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });

              if (reviews.length === 0 && comments.length === 0) {
                const elapsedHours = (now - new Date(pr.created_at)) / (1000 * 60 * 60);
                
                if (elapsedHours >= slaThreshold) {
                  qualifyingPrs.push({
                    number: pr.number,
                    title: pr.title,
                    author: pr.user.login,
                    url: pr.html_url,
                    elapsedHours: elapsedHours.toFixed(1)
                  });
                }
              }
            }
            
            core.setOutput('qualifying_prs', JSON.stringify(qualifyingPrs));

      - name: Send Basecamp Nudge
        if: fromJSON(steps.filter-prs.outputs.qualifying_prs)[0] != null
        env:
          BASECAMP_WEBHOOK_URL: ${{ secrets.BASECAMP_WEBHOOK_URL }}
          REPO_DEFAULT_MENTIONS: ${{ vars.DEFAULT_TEAM_MENTIONS }}
        uses: actions/github-script@v7
        with:
          script: |
            const https = require('https');
            const prs = JSON.parse(`${{ steps.filter-prs.outputs.qualifying_prs }}`);
            
            const manualMentions = `${{ github.event.inputs.team_mentions }}`;
            const repoMentions = process.env.REPO_DEFAULT_MENTIONS;
            const fallbackMentions = '@thmanyah-technical-team';

            let rawMentions = fallbackMentions;
            if (manualMentions && manualMentions.trim() !== "" && manualMentions.trim() !== "undefined") {
                rawMentions = manualMentions;
            } else if (repoMentions && repoMentions.trim() !== "") {
                rawMentions = repoMentions;
            }

            const formattedMentions = rawMentions.split(',').map(m => m.trim()).join(' ');
            const webhookUrl = process.env.BASECAMP_WEBHOOK_URL;

            for (const pr of prs) {
              const status = pr.elapsedHours >= 24 ? "âš ï¸ **EXCEEDS 24h SLA**" : "ðŸ”” **APPROACHING SLA**";
              
              const message = `${status}\n` +
                              `PR #${pr.number}: ${pr.title}\n` +
                              `Author: @${pr.author}\n` +
                              `Time open: ${pr.elapsedHours} hours\n` +
                              `Link: ${pr.url}\n\n` +
                              `${formattedMentions} Please review this PR to unblock the team! ðŸš€`;

              const postData = JSON.stringify({ content: message });
              const url = new URL(webhookUrl);
              
              const options = {
                hostname: url.hostname,
                path: url.pathname,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Content-Length': Buffer.byteLength(postData)
                }
              };

              const req = https.request(options, (res) => {
                console.log(`PR #${pr.number} Nudged - Response: ${res.statusCode}`);
              });
              
              req.write(postData);
              req.end();
              await new Promise(r => setTimeout(r, 1000));
            }
